<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>StaticMocks by jcansdale</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">StaticMocks</h1>
      <h2 class="project-tagline">A mocking library capable of mocking .NET and .NET Core static methods</h2>
      <a href="https://github.com/jcansdale/StaticMocks" class="btn">View on GitHub</a>
      <a href="https://github.com/jcansdale/StaticMocks/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/jcansdale/StaticMocks/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="a-mocking-library-capable-of-mocking-net-and-net-core-static-methods" class="anchor" href="#a-mocking-library-capable-of-mocking-net-and-net-core-static-methods" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A mocking library capable of mocking .NET and .NET Core static methods</h3>

<h4>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Getting started</h4>

<p><em>For convenience I've put the sample code <a href="https://raw.githubusercontent.com/jcansdale/StaticMocks/master/example.cs">here</a>.</em></p>

<ul>
<li>
<p>Take the following target code.</p>

<div class="highlight highlight-source-cs"><pre>  <span class="pl-k">using</span> <span class="pl-en">System.IO</span>;

  <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TargetClass</span>
  {
      <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">string</span> <span class="pl-en">ShoutFile</span>(<span class="pl-k">string</span> <span class="pl-smi">path</span>)
      {
          <span class="pl-k">var</span> text = File.ReadAllText(path);
          <span class="pl-k">return</span> text.ToUpperInvariant();
      }
  }</pre></div>
</li>
<li><p>Install the <em>StaticMocks</em> package from NuGet (check 'Incude prerelease'). <em>StaticMocks</em> works nicely with <a href="http://nsubstitute.github.io/">NSubstitute 2.0</a> and will automatically pull in that package. It also has a simple Moq-like interface if you need to remove the <em>NSubstitute</em> dependency.</p></li>
<li><p>Write the following test code.</p></li>
</ul>

<div class="highlight highlight-source-cs"><pre>    <span class="pl-k">using</span> <span class="pl-en">System</span>;
    <span class="pl-k">using</span> <span class="pl-en">System.IO</span>;
    <span class="pl-k">using</span> <span class="pl-en">StaticMocks</span>;
    <span class="pl-k">using</span> <span class="pl-en">NSubstitute</span>;
    <span class="pl-k">using</span> <span class="pl-en">NUnit.Framework</span>;

    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TargetClassTests</span>
    {
        [Test]
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">ShoutFile</span>()
        {
            <span class="pl-k">using</span> (<span class="pl-k">var</span> staticMock = <span class="pl-k">new</span> StaticMock(<span class="pl-k">typeof</span>(TargetClass)))
            {
                staticMock.For(() =&gt; File.ReadAllText(<span class="pl-s"><span class="pl-pds">"</span>foo.txt<span class="pl-pds">"</span></span>)).Returns(<span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>);

                <span class="pl-k">var</span> text = TargetClass.ShoutFile(<span class="pl-s"><span class="pl-pds">"</span>foo.txt<span class="pl-pds">"</span></span>);

                Assert.That(text, Is.EqualTo(<span class="pl-s"><span class="pl-pds">"</span>BAR<span class="pl-pds">"</span></span>));
            }
        }
    }</pre></div>

<ul>
<li>Run the <code>ShoutFile</code> test. If you're using <a href="http://testdriven.net">TestDriven.Net</a> you will see the following.</li>
</ul>

<pre><code>------ Test started: Assembly: Target.Tests.dll ------

Test 'Target.Tests.TargetClassTests.ShoutFile' failed: StaticMocks.StaticMockException:

Please add the following as a nested class to 'Target.Tests.TargetClass':

class File
{
    internal static Func&lt;string, string&gt; ReadAllText = (string path) =&gt; System.IO.File.ReadAllText(path);
}
    Samples\Sample1.cs(17,0): at Samples.Tests.TargetClassTests.ShoutFile()

0 passed, 1 failed, 0 skipped, took 0.67 seconds (NUnit 3.4.1).
</code></pre>

<ul>
<li>Do as the exception message suggests and change your target code to this.</li>
</ul>

<div class="highlight highlight-source-cs"><pre>    <span class="pl-k">using</span> <span class="pl-en">System</span>;

    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TargetClass</span>
    {
        <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">string</span> <span class="pl-en">ShoutFile</span>(<span class="pl-k">string</span> <span class="pl-smi">path</span>)
        {
            <span class="pl-k">var</span> text = File.ReadAllText(path);
            <span class="pl-k">return</span> text.ToUpperInvariant();
        }

        <span class="pl-k">class</span> <span class="pl-en">File</span>
        {
            <span class="pl-k">internal</span> <span class="pl-k">static</span> Func&lt;<span class="pl-k">string</span>, <span class="pl-k">string</span>&gt; ReadAllText = (<span class="pl-k">string</span> path) =&gt; System.IO.File.ReadAllText(path);
        }
    }</pre></div>

<ul>
<li>Run the <code>ShoutFile</code> test again and rejoice when the test passes!</li>
</ul>

<h4>
<a id="how-can-you-verify-that-a-static-method-was-called" class="anchor" href="#how-can-you-verify-that-a-static-method-was-called" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How can you verify that a static method was called?</h4>

<p>You can do this using <code>StaticMock.Received</code>. For example, the following method:</p>

<div class="highlight highlight-source-cs"><pre>[Test]
<span class="pl-k">public</span> <span class="pl-k">void</span> ShoutFile()
{
    <span class="pl-k">using</span> (<span class="pl-k">var</span> staticMock = <span class="pl-k">new</span> StaticMock(<span class="pl-k">typeof</span>(TargetClass)))
    {
        staticMock.For(() =&gt; File.ReadAllText(<span class="pl-s"><span class="pl-pds">"</span>foo.txt<span class="pl-pds">"</span></span>)).Returns(<span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>);

        <span class="pl-k">var</span> text = TargetClass.ShoutFile(<span class="pl-s"><span class="pl-pds">"</span>foo.txt<span class="pl-pds">"</span></span>);

        staticMock.Received(<span class="pl-c1">1</span>, () =&gt; File.ReadAllText(<span class="pl-s"><span class="pl-pds">"</span>foo.txt<span class="pl-pds">"</span></span>));
    }
}</pre></div>

<p>Will fail with the following:</p>

<pre><code>Test 'ShoutFile' failed: NSubstitute.Exceptions.ReceivedCallsException : Expected to receive exactly 1 call matching:
    Invoke("foo.txt")
Actually received no matching calls.
Received 1 non-matching call (non-matching arguments indicated with '*' characters):
    Invoke(*"oops.txt"*)
</code></pre>

<h4>
<a id="what-happens-if-tests-are-being-run-in-parallel" class="anchor" href="#what-happens-if-tests-are-being-run-in-parallel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What happens if tests are being run in parallel?</h4>

<p><em>StaticMocks</em> enforces a rule that a target type can only be mocked by one <code>StaticMock</code> at a time.
If a parallel test attempts to mock a type more than once, the test will fail with a <code>StaticMockException</code>.</p>

<p>For example, the tests below will fail with the following message (to fix this error, uncomment the <code>[Collection("ReaderTests")]</code> attributes).</p>

<pre><code>------ Test started: Assembly: StaticMocks.ParallelTests.dll ------

Test 'ParallelTests.FooTests.Test' failed: StaticMocks.StaticMockException : There is already an active `StaticMock` for type `Reader`.
If you're using xUnit, ensure that test classes that create a `StaticMock` for `Reader` belong to the same collection.
For example, you could add [Collection("ReaderTests")] to these classes.
    StaticMocks.ParallelTests\Class1.cs(15,0): at ParallelTests.FooTests.Test()

1 passed, 1 failed, 0 skipped, took 0.71 seconds (xUnit.net 2.2.0 build 3402).
</code></pre>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">namespace</span> <span class="pl-en">ParallelTests</span>
{
    <span class="pl-k">using</span> <span class="pl-en">System</span>;
    <span class="pl-k">using</span> <span class="pl-en">System.IO</span>;
    <span class="pl-k">using</span> <span class="pl-en">Xunit</span>;
    <span class="pl-k">using</span> <span class="pl-en">NSubstitute</span>;
    <span class="pl-k">using</span> <span class="pl-en">StaticMocks</span>;

    <span class="pl-c">// [Collection("ReaderTests")]</span>
    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FooTests</span>
    {
        [Fact]
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">Test</span>()
        {
            <span class="pl-k">using</span> (<span class="pl-k">var</span> staticMock = <span class="pl-k">new</span> StaticMock(<span class="pl-k">typeof</span>(Reader)))
            {
                staticMock.For(() =&gt; File.ReadAllText(<span class="pl-s"><span class="pl-pds">"</span>readme.txt<span class="pl-pds">"</span></span>)).Returns(<span class="pl-s"><span class="pl-pds">"</span>foo<span class="pl-pds">"</span></span>);
                Assert.Equal(<span class="pl-s"><span class="pl-pds">"</span>foo<span class="pl-pds">"</span></span>, Reader.ReadAllText(<span class="pl-s"><span class="pl-pds">"</span>readme.txt<span class="pl-pds">"</span></span>));
            }
        }
    }

    <span class="pl-c">// [Collection("ReaderTests")]</span>
    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">BarTests</span>
    {
        [Fact]
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">Test</span>()
        {
            <span class="pl-k">using</span> (<span class="pl-k">var</span> staticMock = <span class="pl-k">new</span> StaticMock(<span class="pl-k">typeof</span>(Reader)))
            {
                staticMock.For(() =&gt; File.ReadAllText(<span class="pl-s"><span class="pl-pds">"</span>readme.txt<span class="pl-pds">"</span></span>)).Returns(<span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>);
                Assert.Equal(<span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>, Reader.ReadAllText(<span class="pl-s"><span class="pl-pds">"</span>readme.txt<span class="pl-pds">"</span></span>));
            }
        }
    }

    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Reader</span>
    {
        <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">string</span> <span class="pl-en">ReadAllText</span>(<span class="pl-k">string</span> <span class="pl-smi">path</span>)
        {
            <span class="pl-k">return</span> File.ReadAllText(path);
        }

        <span class="pl-k">class</span> <span class="pl-en">File</span>
        {
            <span class="pl-k">internal</span> <span class="pl-k">static</span> Func&lt;<span class="pl-k">string</span>, <span class="pl-k">string</span>&gt; ReadAllText = (<span class="pl-k">string</span> path) =&gt; System.IO.File.ReadAllText(path);
        }
    }
}</pre></div>

<p>The <code>[Collection(...)]</code> attributes are only necessary when a target class is being mocked by multiple xUnit test fixtures.
By default NUnit doesn't do parallel testing of fixtures, so this shouldn't be an issue unless you explicitly enable it.</p>

<h4>
<a id="conclusion" class="anchor" href="#conclusion" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Conclusion</h4>

<p>You've just tested a static method without touching the public interface of
its containing class or running your tests with a special tool. This was made
possible by adding a single auto-generated field/class to the class under test.
You could use <code>#if DEBUG</code> to remove this from the released assembly if you're
so inclined.</p>

<p>This is by no means perfect, but it's useful in a lot of common scenarios.
I've been dogfooding it for a little while now.</p>

<h4>
<a id="faq" class="anchor" href="#faq" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>FAQ</h4>

<p>Ask away in the issues section or tweet me! <a href="https://twitter.com/jcansdale">jcansdale@twitter.com</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jcansdale/StaticMocks">StaticMocks</a> is maintained by <a href="https://github.com/jcansdale">jcansdale</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
